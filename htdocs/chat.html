<!doctype html>
<html>
<head>
  <link href='http://fonts.googleapis.com/css?family=Oswald:400,300' rel='stylesheet'>
  <link href="lib/bootstrap.min.css" rel="stylesheet">
  <link href="styles/index.css" rel="stylesheet">
  <style>
    .conversation {
      height: 80vh;
      max-height: 80vh;
      margin:20px 0;
      overflow-y: scroll;
      width: 100%;
      border-radius: 2%;
      padding:10px;
      border-color: #999;
      border-width: 5px;
    }

    .answer {
      min-height: 50px;
      max-height: 100px;
      margin: auto;

      width: 100%;
    }

    input {
      padding:10px;
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
<div class="header">
  <div class="container">
    <a href="/" class="logo-icon">
      <img src="styles/logoami128.png" style="max-height: 48px;max-width:48px;">
    </a>

    <ul class="menu">
      <li><a href="#level1" class="level1">Talk to me</a></li>

      <li><a href="#level2" class="level2">Check In</a></li>
      <li><a href="#level3" class="level3">Crisis</a></li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle">More <b class="caret"></b></a>
        <ul class="dropdown-menu">
          <li><a href="#">Log In</a></li>
          <li><a href="#">Sign Up</a></li>
          <li><a href="#">Community</a></li>
          <li><a href="#">Numbers</a></li>
        </ul>
      </li>
    </ul>
  </div>
</div>

<div class='row' style='min-height:400px; display: none'>

  <form class='form' role='form' onsubmit="return false;">
    <div class='form-group'>
      <input id="url" type="text" class="form-control" placeholder="URL"/>
    </div>
    <div class='form-group'>
      <input id="app_key" type="text" class="form-control" placeholder="AppKey"/>
    </div>
    <div class='form-group'>
      <input id="app_id" type="text" class="form-control" placeholder="AppId"/>
    </div>
    <div class='form-group'>
      <input id="user_id" type="text" class="form-control" placeholder="UserId"/>
    </div>
    <div class='form-group'>
      <button id='connect' type='button' class='btn btn-primary btn-block'><i class='fa fa-check'></i> CONNECT
      </button>
    </div>
  </form>
</div>
<div class="container">
  <div class="conversation">
    Text will appear here...
  </div>
<div class="answer">
  <input placeholder="Enter your answer here...">
</div>
</div>
<script src="lib/jquery.min.js"></script>
<script src="script.js"></script>

<script>
  (function () {

    //Set these to avoid having to enter them everytime
    var URL = 'wss://httpapi.labs.nuance.com/v1?';
    var APP_ID = "NMDPTRIAL_yusairamk_hotmail_com20151003124820";
    var APP_KEY = "5fe9253698aa4d70d23d16af27fbfc6fb3f5cb36ed459dab974acd1a9320b8f209dd29a287761259b32808db23054ad7fa150de85bab93f2f5610c8881c47b8b";
    var USER_ID = "1";
    var NLU_TAG = "V1_Project775_App375";


    var userMedia = undefined;
    navigator.getUserMedia({
      audio: true
    }, function (stream) {
      userMedia = stream;
    }, function (error) {
      console.error("Could not get User Media: " + error);
    });

    //
    // APP STATE
    var isRecording = false;
    // NODES
    var $content = $('#content');
    var $url = $('#url');
    var $appKey = $('#app_key');
    var $appId = $('#app_id');
    var $userId = $('#user_id');
    var $nluTag = $('#nlu_tag');
    var $connect = $('#connect');
    var $ttsGo = $('#tts_go');
    var $ttsText = $('#tts_text');
    var $ttsDebug = $('#tts_debug_output');
    var $asrRecord = $('#asr_go');
    var $asrLabel = $('#asr_label');
    var $asrViz = $('#asr_viz');
    var $asrDebug = $('#asr_debug_output');
    var $asrVizCtx = $asrViz.get()[0].getContext('2d');

    var dLog = function dLog(msg, logger) {
      var d = new Date();
      logger.prepend('<div><em>' + d.toISOString() + '</em> &nbsp; <pre>' + msg + '</pre></div>');
    };


    //
    // Connect
    function connect() {

      // INIT THE SDK
      Nuance.connect({
        appId: $appId.val(),
        appKey: $appKey.val(),
        userId: $userId.val(),
        url: $url.val(),

        onopen: function () {
          console.log("Websocket Opened");
          $content.addClass('connected');
        },
        onclose: function () {
          console.log("Websocket Closed");
          $content.removeClass('connected');
        },
        onmessage: function (msg) {
          console.log(msg);
          if (msg.message == "volume") {
            viz(msg.volume);
          } else if (msg.result_type == "NVC_TTS_CMD") {
            dLog(JSON.stringify(msg, null, 2), $ttsDebug);
          } else if (msg.result_type == "NDSP_ASR_APP_CMD") {
            dLog(JSON.stringify(msg, null, 2), $asrDebug);
          }
        },
        onerror: function (error) {
          console.error(error);
          $content.removeClass('connected');
        }

      });
    };
    $url.val(URL || '');
    $appId.val(APP_ID || '');
    $appKey.val(APP_KEY || '');
    $userId.val(USER_ID || '');
    $nluTag.val(NLU_TAG || '');


    $(window).on('load', connect);
    // Disconnect
    $(window).unload(function () {
      Nuance.disconnect();
    });


    //
    // TTS
    function tts(evt) {
      Nuance.playTTS({
        language: 'eng-USA',
        voice: 'ava',
        text: $ttsText.val()
      });
    };
    $ttsGo.on('click', tts);


    //
    // ASR / NLU
    function asr(evt) {
      if (isRecording) {
        Nuance.stopASR();
        $asrLabel.text('RECORD');
      } else {

        var options = {
          userMedia: userMedia
        };
        if ($nluTag.val()) {
          options.nlu = true;
          options.tag = $nluTag.val();
        }
        Nuance.startASR(options);
        $asrLabel.text('STOP RECORDING');
      }
      isRecording = !isRecording;
    };
    $asrRecord.on('click', asr);


    //
    // ASR Volume visualization

    window.requestAnimFrame = (function () {
      return window.requestAnimatiindex.htmlonFrame ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame ||
          function (callback, element) {
            window.setTimeout(callback, 1000 / 60);
          };
    })();

    var asrVizData = {};

    function cleanViz() {
      var parentWidth = $asrViz.parent().width();
      $asrViz[0].getContext('2d').canvas.width = parentWidth;
      asrVizData = {
        w: parentWidth,
        h: 256,
        col: 0,
        tickWidth: 0.5
      };
      var w = asrVizData.w, h = asrVizData.h;
      $asrVizCtx.clearRect(0, 0, w, h); // TODO: pull out height/width
      $asrVizCtx.strokeStyle = '#333';
      var y = (h / 2) + 0.5;
      $asrVizCtx.moveTo(0, y);
      $asrVizCtx.lineTo(w - 1, y);
      $asrVizCtx.stroke();
      asrVizData.col = 0;
    };

    function viz(amplitudeArray) {
      var h = asrVizData.h;
      requestAnimFrame(function () {
        // Drawing the Time Domain onto the Canvas element
        var min = 999999;
        var max = 0;
        for (var i = 0; i < amplitudeArray.length; i++) {
          var val = amplitudeArray[i] / asrVizData.h;
          if (val > max) {
            max = val;
          } else if (val < min) {
            min = val;
          }
        }
        var yLow = h - (h * min) - 1;
        var yHigh = h - (h * max) - 1;
        $asrVizCtx.fillStyle = '#6d8f52';
        $asrVizCtx.fillRect(asrVizData.col, yLow, asrVizData.tickWidth, yHigh - yLow);
        asrVizData.col += 1;
        if (asrVizData.col >= asrVizData.w) {
          asrVizData.col = 0;
        }
      });
    };

  })();
</script>
</body>
</html>